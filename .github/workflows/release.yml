name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全履歴取得してタグの所属ブランチを確認可能にする

      - name: Verify tag is on main
        shell: pwsh
        run: |
          # 取得した全履歴から、現在のコミット(GitHubタグ)を含むリモートブランチを確認
          $branches = git branch -r --contains ${{ github.sha }}
          $isOnMain = $branches | Where-Object { $_ -match "origin/main" }
          if (-not $isOnMain) {
            Write-Error "Tag must be on 'main' branch to trigger a release. Tagged commit found in branches: $branches"
            exit 1
          }
          Write-Host "[OK] Tag is on main branch."

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      # ── Version management ──────────────────────────────────────────────
      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"           # e.g. "v1.2.0"
          $ver = $tag.TrimStart("v")                  # e.g. "1.2.0"
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT
          echo "Releasing version: $ver"

      - name: Validate & sync version
        shell: pwsh
        run: |
          # Validates that pyproject.toml version matches the tag,
          # then updates AppxManifest.xml and MixedBerryPie.iss (build-time only, no commit).
          uv run python scripts/update_version.py ${{ steps.version.outputs.VERSION }}

      - name: Generate Icons & Assets
        run: uv run python scripts/convert_icon.py
        env:
          QT_QPA_PLATFORM: offscreen

      # ── Build ───────────────────────────────────────────────────────────
      - name: Build Executable
        run: uv run python scripts/build.py

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build Installer (Inno Setup)
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" MixedBerryPie.iss
          # Rename to versioned filename
          $ver = "${{ steps.version.outputs.VERSION }}"
          $src = "Output\MixedBerryPie_Setup_v${ver}.exe"
          if (-not (Test-Path $src)) {
            # fallback: find whatever was generated
            $src = Get-ChildItem Output\*.exe | Select-Object -First 1 -ExpandProperty FullName
            Rename-Item $src "MixedBerryPie_Setup_v${ver}.exe"
          }

      - name: Build MSIX (unsigned, for Store submission)
        shell: pwsh
        run: |
          .\scripts\package_msix.ps1 -Version ${{ steps.version.outputs.VERSION }}

      # ── Release ─────────────────────────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Output/MixedBerryPie_Setup_v${{ steps.version.outputs.VERSION }}.exe
            dist/MixedBerryPie_v${{ steps.version.outputs.VERSION }}.msix
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
